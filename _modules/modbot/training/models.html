<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>modbot.training.models &mdash; modbot v1.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> modbot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../includeme.html">Home Page</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../includeme.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../includeme.html#environment-variables">Environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../includeme.html#training-model">Training Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../includeme.html#running">Running</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/modbot.html">API reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/modbot.modbot_argparse.html">modbot.modbot_argparse</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.modbot_argparse.html#modbot.modbot_argparse"><code class="docutils literal notranslate"><span class="pre">modbot_argparse()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/modbot.connection.html">modbot.connection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.connection.base.html">modbot.connection.base</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.connection.base.BaseSocketClientAsync.html">modbot.connection.base.BaseSocketClientAsync</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.connection.base.StreamHandlerAsync.html">modbot.connection.base.StreamHandlerAsync</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.connection.irc_client.html">modbot.connection.irc_client</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.connection.irc_client.IrcSocketClientAsync.html">modbot.connection.irc_client.IrcSocketClientAsync</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.connection.pubsub_client.html">modbot.connection.pubsub_client</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.connection.pubsub_client.WebSocketClientAsync.html">modbot.connection.pubsub_client.WebSocketClientAsync</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/modbot.environment.html">modbot.environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.environment.get_model_path.html">modbot.environment.get_model_path</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.environment.get_model_path.html#modbot.environment.get_model_path"><code class="docutils literal notranslate"><span class="pre">get_model_path()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.environment.BaseConfig.html">modbot.environment.BaseConfig</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.environment.BaseConfig.html#modbot.environment.BaseConfig"><code class="docutils literal notranslate"><span class="pre">BaseConfig</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.environment.ProcessingConfig.html">modbot.environment.ProcessingConfig</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.environment.ProcessingConfig.html#modbot.environment.ProcessingConfig"><code class="docutils literal notranslate"><span class="pre">ProcessingConfig</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.environment.RunConfig.html">modbot.environment.RunConfig</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.environment.RunConfig.html#modbot.environment.RunConfig"><code class="docutils literal notranslate"><span class="pre">RunConfig</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/modbot.moderation.html">modbot.moderation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.moderation.Moderation.html">modbot.moderation.Moderation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.moderation.Moderation.html#modbot.moderation.Moderation"><code class="docutils literal notranslate"><span class="pre">Moderation</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.moderation.Nuking.html">modbot.moderation.Nuking</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.moderation.Nuking.html#modbot.moderation.Nuking"><code class="docutils literal notranslate"><span class="pre">Nuking</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.moderation.Permitting.html">modbot.moderation.Permitting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.moderation.Permitting.html#modbot.moderation.Permitting"><code class="docutils literal notranslate"><span class="pre">Permitting</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.html">modbot.preprocessing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.check_msgs.html">modbot.preprocessing.check_msgs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.check_msgs.html#modbot.preprocessing.check_msgs"><code class="docutils literal notranslate"><span class="pre">check_msgs()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.check_phrases.html">modbot.preprocessing.check_phrases</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.check_phrases.html#modbot.preprocessing.check_phrases"><code class="docutils literal notranslate"><span class="pre">check_phrases()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.check_probs.html">modbot.preprocessing.check_probs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.check_probs.html#modbot.preprocessing.check_probs"><code class="docutils literal notranslate"><span class="pre">check_probs()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.contains_link.html">modbot.preprocessing.contains_link</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.contains_link.html#modbot.preprocessing.contains_link"><code class="docutils literal notranslate"><span class="pre">contains_link()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.correct_messages.html">modbot.preprocessing.correct_messages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.correct_messages.html#modbot.preprocessing.correct_messages"><code class="docutils literal notranslate"><span class="pre">correct_messages()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.correct_msg.html">modbot.preprocessing.correct_msg</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.correct_msg.html#modbot.preprocessing.correct_msg"><code class="docutils literal notranslate"><span class="pre">correct_msg()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.filter_all_emotes.html">modbot.preprocessing.filter_all_emotes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.filter_all_emotes.html#modbot.preprocessing.filter_all_emotes"><code class="docutils literal notranslate"><span class="pre">filter_all_emotes()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.filter_emotes.html">modbot.preprocessing.filter_emotes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.filter_emotes.html#modbot.preprocessing.filter_emotes"><code class="docutils literal notranslate"><span class="pre">filter_emotes()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.filter_log.html">modbot.preprocessing.filter_log</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.filter_log.html#modbot.preprocessing.filter_log"><code class="docutils literal notranslate"><span class="pre">filter_log()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.get_info_from_chatty.html">modbot.preprocessing.get_info_from_chatty</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.get_info_from_chatty.html#modbot.preprocessing.get_info_from_chatty"><code class="docutils literal notranslate"><span class="pre">get_info_from_chatty()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.join_words.html">modbot.preprocessing.join_words</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.join_words.html#modbot.preprocessing.join_words"><code class="docutils literal notranslate"><span class="pre">join_words()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.my_lemmatizer.html">modbot.preprocessing.my_lemmatizer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.my_lemmatizer.html#modbot.preprocessing.my_lemmatizer"><code class="docutils literal notranslate"><span class="pre">my_lemmatizer()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.my_tokenizer.html">modbot.preprocessing.my_tokenizer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.my_tokenizer.html#modbot.preprocessing.my_tokenizer"><code class="docutils literal notranslate"><span class="pre">my_tokenizer()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.preproc_words.html">modbot.preprocessing.preproc_words</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.preproc_words.html#modbot.preprocessing.preproc_words"><code class="docutils literal notranslate"><span class="pre">preproc_words()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.read_data.html">modbot.preprocessing.read_data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.read_data.html#modbot.preprocessing.read_data"><code class="docutils literal notranslate"><span class="pre">read_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.remove_stopwords.html">modbot.preprocessing.remove_stopwords</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.remove_stopwords.html#modbot.preprocessing.remove_stopwords"><code class="docutils literal notranslate"><span class="pre">remove_stopwords()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.segment_words.html">modbot.preprocessing.segment_words</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.segment_words.html#modbot.preprocessing.segment_words"><code class="docutils literal notranslate"><span class="pre">segment_words()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.separate_links.html">modbot.preprocessing.separate_links</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.separate_links.html#modbot.preprocessing.separate_links"><code class="docutils literal notranslate"><span class="pre">separate_links()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.separate_tocheck.html">modbot.preprocessing.separate_tocheck</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.separate_tocheck.html#modbot.preprocessing.separate_tocheck"><code class="docutils literal notranslate"><span class="pre">separate_tocheck()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.write_data.html">modbot.preprocessing.write_data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.write_data.html#modbot.preprocessing.write_data"><code class="docutils literal notranslate"><span class="pre">write_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.LogCleaning.html">modbot.preprocessing.LogCleaning</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.LogCleaning.html#modbot.preprocessing.LogCleaning"><code class="docutils literal notranslate"><span class="pre">LogCleaning</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.MsgMemory.html">modbot.preprocessing.MsgMemory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.preprocessing.MsgMemory.html#modbot.preprocessing.MsgMemory"><code class="docutils literal notranslate"><span class="pre">MsgMemory</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/modbot.training.html">modbot.training</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.training.get_model_class.html">modbot.training.get_model_class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.training.get_model_class.html#modbot.training.get_model_class"><code class="docutils literal notranslate"><span class="pre">get_model_class()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.training.training_argparse.html">modbot.training.training_argparse</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.training.training_argparse.html#modbot.training.training_argparse"><code class="docutils literal notranslate"><span class="pre">training_argparse()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/modbot.utilities.html">modbot.utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.utilities.logging.html">modbot.utilities.logging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.logging.get_logger.html">modbot.utilities.logging.get_logger</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.logging.ColoredFormatter.html">modbot.utilities.logging.ColoredFormatter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.logging.CustomLogger.html">modbot.utilities.logging.CustomLogger</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.logging.Logging.html">modbot.utilities.logging.Logging</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.logging.PrivateLogger.html">modbot.utilities.logging.PrivateLogger</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.utilities.loss_metrics.html">modbot.utilities.loss_metrics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.loss_metrics.gaussian_kernel.html">modbot.utilities.loss_metrics.gaussian_kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.loss_metrics.max_mean_discrepancy.html">modbot.utilities.loss_metrics.max_mean_discrepancy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.html">modbot.utilities.utilities</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.curvature.html">modbot.utilities.utilities.curvature</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.delete_usernames.html">modbot.utilities.utilities.delete_usernames</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.get_badges.html">modbot.utilities.utilities.get_badges</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.get_line_type.html">modbot.utilities.utilities.get_line_type</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.get_message.html">modbot.utilities.utilities.get_message</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.get_msg_id.html">modbot.utilities.utilities.get_msg_id</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.get_role.html">modbot.utilities.utilities.get_role</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.get_user.html">modbot.utilities.utilities.get_user</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.get_user_type_chatty.html">modbot.utilities.utilities.get_user_type_chatty</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.is_line_type.html">modbot.utilities.utilities.is_line_type</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.is_user_type_chatty.html">modbot.utilities.utilities.is_user_type_chatty</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.is_user_type_irc.html">modbot.utilities.utilities.is_user_type_irc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.none_or_float.html">modbot.utilities.utilities.none_or_float</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.none_or_int.html">modbot.utilities.utilities.none_or_int</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.none_or_str.html">modbot.utilities.utilities.none_or_str</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.parse_radiation.html">modbot.utilities.utilities.parse_radiation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.parse_time.html">modbot.utilities.utilities.parse_time</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.prune_chars.html">modbot.utilities.utilities.prune_chars</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.remove_reps.html">modbot.utilities.utilities.remove_reps</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.remove_special_chars.html">modbot.utilities.utilities.remove_special_chars</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.simple_chars_equal.html">modbot.utilities.utilities.simple_chars_equal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/modbot.utilities.utilities.UserInfo.html">modbot.utilities.utilities.UserInfo</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/modbot.version.html">modbot.version</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/cmd.html">Command Line Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../misc/cmd_training.html">Training Command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../misc/cmd_training.html#named-arguments">Named Arguments</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">modbot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../modbot.html">modbot</a></li>
          <li class="breadcrumb-item"><a href="../training.html">modbot.training</a></li>
      <li class="breadcrumb-item active">modbot.training.models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for modbot.training.models</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Models&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">dask.dataframe</span> <span class="k">as</span> <span class="nn">dd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">import</span> <span class="nn">tensorflow_hub</span> <span class="k">as</span> <span class="nn">tf_hub</span>
<span class="kn">import</span> <span class="nn">tensorflow_text</span> <span class="k">as</span> <span class="nn">tf_text</span>  <span class="c1"># pylint: disable=unused-import # noqa: F401</span>

<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="p">(</span><span class="n">TensorDataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">SequentialSampler</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">AdamW</span>

<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BertModel</span><span class="p">,</span> <span class="n">get_linear_schedule_with_warmup</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">BertTokenizerFast</span> <span class="k">as</span> <span class="n">BertTokenizer</span>

<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">optimizers</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>
<span class="kn">import</span> <span class="nn">sklearn.calibration</span> <span class="k">as</span> <span class="nn">cal</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">TruncatedSVD</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
                             <span class="n">jaccard_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">dask_ml.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>

<span class="kn">from</span> <span class="nn">modbot.training.vectorizers</span> <span class="kn">import</span> <span class="n">TokVectorizer</span>
<span class="kn">from</span> <span class="nn">modbot.training.data_handling</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DataGenerator</span><span class="p">,</span> <span class="n">WeightedGenerator</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">modbot.utilities.utilities</span> <span class="kn">import</span> <span class="n">curvature</span>
<span class="kn">from</span> <span class="nn">modbot.utilities.logging</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">modbot</span> <span class="kn">import</span> <span class="n">preprocessing</span> <span class="k">as</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">modbot</span> <span class="kn">import</span> <span class="n">BERT_ENCODER</span><span class="p">,</span> <span class="n">BERT_PREPROCESS</span>

<span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_detect_anomaly</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">emit_nvtx</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="ModerationModel"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel">[docs]</a><span class="k">class</span> <span class="nc">ModerationModel</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base moderation model class&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">texts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ModerationModel.clean_text"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.clean_text">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean single text so it is utf-8 compliant</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        text : str</span>
<span class="sd">            Text string to clean</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Cleaned text string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to clean text: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModerationModel.clean_texts"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.clean_texts">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clean_texts</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean texts so they are utf-8 compliant</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            Pandas dataframe of texts</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            Pandas dataframe of cleaned texts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">clean_text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">clean_text</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">clean_text</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span></div>

<div class="viewcode-block" id="ModerationModel.load_data"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.load_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load data from csv file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_file : str</span>
<span class="sd">            Path to csv file storing texts and labels</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            Pandas dataframe of texts and labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading in data: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">clean_text</span><span class="p">,</span>
                                          <span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ModerationModel.split_data"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.split_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split data into training and test sets</span>

<span class="sd">        Parameters</span>
<span class="sd">        -------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            Pandas dataframe of texts and labels</span>
<span class="sd">        test_split : float</span>
<span class="sd">            Fraction of full dataset to use for test data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_train : pd.DataFrame</span>
<span class="sd">            Pandas dataframe of texts and labels for training</span>
<span class="sd">        df_test : pd.DataFrame</span>
<span class="sd">            Pandas dataframe of texts and labels for testing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Splitting data&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_split</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                               <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_offensive&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ModerationModel.score"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Score model against targets</span>

<span class="sd">        Parameters</span>
<span class="sd">        -------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            Pandas dataframe of texts</span>
<span class="sd">        Y : pd.DataFrame</span>
<span class="sd">            Pandas dataframe of labels for the corresponding texts</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Value of accuracy calulated from the correct predictions vs base</span>
<span class="sd">            truth</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModerationModel.save"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outpath : str</span>
<span class="sd">            Path to save model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;.joblib&#39;</span> <span class="ow">in</span> <span class="n">outpath</span><span class="p">:</span>
                <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_dir</span> <span class="o">=</span> <span class="n">outpath</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model: </span><span class="si">{</span><span class="n">outpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
                <span class="n">history_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;history.csv&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving history: </span><span class="si">{</span><span class="n">history_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">history_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;vectorizer.pkl&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">vec_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vec_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving vectorizer to: </span><span class="si">{</span><span class="n">vec_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">save_params</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Outpath is None. Not saving </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModerationModel.get_data_generators"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.get_data_generators">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_data_generators</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get data generators with correct sizes</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_file : str</span>
<span class="sd">            Path to csv file storing texts and labels</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary with optional keyword parameters. Can include</span>
<span class="sd">            sample_size, batch_size, epochs, n_batches.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        train_gen : WeightedGenerator</span>
<span class="sd">            WeightedGenerator instance used for training batches</span>
<span class="sd">        test_gen : WeightedGenerator</span>
<span class="sd">            WeightedGenerator instance used for evaluation batches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_split</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_split&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">split_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_split</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting training data generator&#39;</span><span class="p">)</span>
        <span class="n">train_sample_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">train_sample_size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span> <span class="k">if</span> <span class="n">train_sample_size</span> <span class="ow">is</span> <span class="kc">None</span>
                             <span class="k">else</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_split</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_sample_size</span><span class="p">))</span>
        <span class="n">train_kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">train_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;sample_size&#39;</span><span class="p">:</span> <span class="n">train_sample_size</span><span class="p">})</span>
        <span class="n">train_gen</span> <span class="o">=</span> <span class="n">WeightedGenerator</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="o">**</span><span class="n">train_kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting test data generator&#39;</span><span class="p">)</span>
        <span class="n">test_sample_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">test_sample_size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span> <span class="k">if</span> <span class="n">test_sample_size</span> <span class="ow">is</span> <span class="kc">None</span>
                            <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_sample_size</span> <span class="o">-</span> <span class="n">train_sample_size</span><span class="p">))</span>
        <span class="n">test_kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">test_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;sample_size&#39;</span><span class="p">:</span> <span class="n">test_sample_size</span><span class="p">})</span>
        <span class="n">test_gen</span> <span class="o">=</span> <span class="n">WeightedGenerator</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="o">**</span><span class="n">test_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span></div>

<div class="viewcode-block" id="ModerationModel.get_class_info"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.get_class_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_class_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get info about class numbers&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using n_zeros=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1"> and &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;n_ones=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1"> for training.&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using n_zeros=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1"> and &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;n_ones=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1"> for testing.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModerationModel.run"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.run">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run model pipeline. Load data, tokenize texts, and train</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_file : str</span>
<span class="sd">            Path to csv file storing texts and labels</span>
<span class="sd">        config : RunConfig</span>
<span class="sd">            Config class with kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ModerationModel</span>
<span class="sd">            Trained and evaluated keras model or svm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_data_generators</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;texts&#39;</span> <span class="ow">in</span> <span class="n">signature</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_gen</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train_gen</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">test_gen</span> <span class="o">=</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span>
        <span class="n">model</span><span class="o">.</span><span class="n">X_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Y_test</span> <span class="o">=</span> <span class="n">test_gen</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">test_gen</span><span class="o">.</span><span class="n">Y</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trained model in </span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="ModerationModel.continue_training"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.continue_training">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">continue_training</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Continue training. Load model, load data, tokenize texts, and train.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_file : str</span>
<span class="sd">            Path to csv file storing texts and labels</span>
<span class="sd">        config : RunConfig</span>
<span class="sd">            Config class with kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        keras.Sequential</span>
<span class="sd">            Trained sequential and evaluated model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_data_generators</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train_gen</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">test_gen</span> <span class="o">=</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span>
        <span class="n">model</span><span class="o">.</span><span class="n">X_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Y_test</span> <span class="o">=</span> <span class="n">test_gen</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">test_gen</span><span class="o">.</span><span class="n">Y</span>
        <span class="n">just_evaluate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;just_evaluate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">just_evaluate</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="ModerationModel.predict"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict classification</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : ndarray | list | pd.DataFrame</span>
<span class="sd">            Set of texts to classify</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Whether to show progress bar for predictions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of predicted classifications for input texts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)])</span></div>

<div class="viewcode-block" id="ModerationModel.predict_one"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.predict_one">[docs]</a>    <span class="k">def</span> <span class="nf">predict_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict probability of label=1</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : ndarray | list | pd.DataFrame</span>
<span class="sd">            Set of texts to classify</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Whether to show progress bar for predictions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of predicted probability for label=1 for input texts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)])</span></div>

<div class="viewcode-block" id="ModerationModel.predict_zero"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.predict_zero">[docs]</a>    <span class="k">def</span> <span class="nf">predict_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict probability of label=0</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : ndarray | list | pd.DataFrame</span>
<span class="sd">            Set of texts to classify</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Whether to show progress bar for predictions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of predicted probability for label=0 for input texts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)])</span></div>

<div class="viewcode-block" id="ModerationModel.model_test"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.model_test">[docs]</a>    <span class="k">def</span> <span class="nf">model_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test model on some key phrases</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : ModerationModel</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">phrases</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;you are so hot&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;its so hot outside&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;its hot outside&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;hot&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;youre dumb&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;im dumb&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;why are you in just chatting&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;im just chatting&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;hes so annoying&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;this bug is annoying&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;go fuck yourself&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;this song fucking rocks&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;she yawned again&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Hey, wanna play chess with me?I&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;wanna go out with me?&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;suck my dick&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;this game sucks&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;you look tired&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;im so tired&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ass&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;you have a nice ass&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;this song is ass&#39;</span>
                   <span class="p">]</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_one</span><span class="p">(</span><span class="n">phrases</span><span class="p">)]</span>

        <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">phrases</span><span class="p">,</span> <span class="s1">&#39;probs&#39;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">test</span></div>

<div class="viewcode-block" id="ModerationModel.detailed_score"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.detailed_score">[docs]</a>    <span class="k">def</span> <span class="nf">detailed_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_gen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_matches</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Score model and print confusion matrix and multiple other metrics</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_gen : WeightedGenerator</span>
<span class="sd">            generator for test data</span>
<span class="sd">        n_matches : int</span>
<span class="sd">            Number of positive matches to print</span>
<span class="sd">        out_dir : str | None</span>
<span class="sd">            Path to save scores</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_scores : pd.DataFrame</span>
<span class="sd">            A dataframe containing all model scores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">test_gen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">test_gen</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">test_gen</span><span class="o">.</span><span class="n">Y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_test</span>

        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting detailed info on model performance&#39;</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_one</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">discrete_preds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">]</span>
        <span class="n">confusion</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">discrete_preds</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Getting info on matches across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;samples&#39;</span><span class="p">)</span>
        <span class="n">discrete_matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">==</span> <span class="n">discrete_preds</span><span class="p">)</span>
        <span class="n">one_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">discrete_matches</span>
        <span class="n">zero_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">discrete_matches</span>
        <span class="n">one_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">one_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">one_indices</span><span class="p">)</span>
        <span class="n">one_indices</span> <span class="o">=</span> <span class="n">one_indices</span><span class="p">[:</span><span class="n">n_matches</span><span class="p">]</span>
        <span class="n">zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">zero_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">)</span>
        <span class="n">zero_indices</span> <span class="o">=</span> <span class="n">zero_indices</span><span class="p">[:</span><span class="n">n_matches</span><span class="p">]</span>
        <span class="n">X_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="n">one_indices</span><span class="p">]</span>
        <span class="n">X_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="n">zero_indices</span><span class="p">]</span>
        <span class="n">X_match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X_ones</span><span class="p">,</span> <span class="n">X_zeros</span><span class="p">])</span>
        <span class="n">one_probs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">one_indices</span><span class="p">]</span>
        <span class="n">zero_probs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">zero_indices</span><span class="p">]</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">one_probs</span><span class="p">,</span> <span class="n">zero_probs</span><span class="p">])</span>
        <span class="n">one_preds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">one_probs</span><span class="p">]</span>
        <span class="n">zero_preds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">zero_probs</span><span class="p">]</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">one_preds</span><span class="p">,</span> <span class="n">zero_preds</span><span class="p">])</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_ones</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_zeros</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_match</span><span class="p">),</span>
                                <span class="s1">&#39;prob&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">probs</span><span class="p">),</span>
                                <span class="s1">&#39;preds&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">,</span>
                                <span class="s1">&#39;truth&#39;</span><span class="p">:</span> <span class="n">truth</span><span class="p">})</span>

        <span class="n">test_ones</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confusion</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])</span>
        <span class="n">test_zeros</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confusion</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computing metrics on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="si">}</span><span class="s1"> samples&#39;</span><span class="p">)</span>
        <span class="n">df_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">discrete_preds</span><span class="p">),</span>
             <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">discrete_preds</span><span class="p">),</span>
             <span class="s1">&#39;jaccard&#39;</span><span class="p">:</span> <span class="n">jaccard_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">discrete_preds</span><span class="p">),</span>
             <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">discrete_preds</span><span class="p">),</span>
             <span class="s1">&#39;TP&#39;</span><span class="p">:</span> <span class="n">confusion</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_ones</span><span class="p">,</span>
             <span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">confusion</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_zeros</span><span class="p">,</span>
             <span class="s1">&#39;TN&#39;</span><span class="p">:</span> <span class="n">confusion</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_zeros</span><span class="p">,</span>
             <span class="s1">&#39;FN&#39;</span><span class="p">:</span> <span class="n">confusion</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_ones</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="s1">&#39;jaccard&#39;</span><span class="p">,</span> <span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="s1">&#39;TP&#39;</span><span class="p">,</span> <span class="s1">&#39;TN&#39;</span><span class="p">]</span>
        <span class="n">df_scores</span><span class="p">[</span><span class="s2">&quot;avg score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_scores</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">_scores.csv&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving model scores to </span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">df_scores</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;First </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_matches</span><span class="p">)</span><span class="si">}</span><span class="s1"> matches:</span><span class="se">\n</span><span class="si">{</span><span class="n">matches</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scores:</span><span class="se">\n</span><span class="si">{</span><span class="n">df_scores</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test phrases:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_test</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_scores</span></div>

<div class="viewcode-block" id="ModerationModel.save_params"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.save_params">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_params</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save params to model path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outpath : str</span>
<span class="sd">            Path to model</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of kwargs used to build model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;.joblib&#39;</span> <span class="ow">in</span> <span class="n">outpath</span><span class="p">:</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="n">outpath</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
        <span class="n">params_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving params: </span><span class="si">{</span><span class="n">params_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">params_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModerationModel.predict_proba"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.predict_proba">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict probability&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="ModerationModel.train"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.train">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train model&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="ModerationModel.load"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load model from path&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="ModerationModel.transform"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.ModerationModel.html#modbot.training.models.ModerationModel.transform">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform texts&quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="NNmodel"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel">[docs]</a><span class="k">class</span> <span class="nc">NNmodel</span><span class="p">(</span><span class="n">ModerationModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base keras model for moderation&quot;&quot;&quot;</span>

    <span class="c1">#: Max vocab size for tokenizer</span>
    <span class="n">MAX_NB_WORDS</span> <span class="o">=</span> <span class="mi">50000</span>

    <span class="c1">#: Embedding dimension size for embdedding layer</span>
    <span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1">#: Max sequence length for tokenizer output</span>
    <span class="n">MAX_SEQUENCE_LENGTH</span> <span class="o">=</span> <span class="mi">250</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        texts : list | ndarray, optional</span>
<span class="sd">            Set of texts used to get vocabulary, by default None</span>
<span class="sd">        clf : keras.Sequential, optional</span>
<span class="sd">            Sequential keras model used when loading from saved dir, by default</span>
<span class="sd">            None</span>
<span class="sd">        vec : TokVectorizer, optional</span>
<span class="sd">            TokVectorizer instance. Used when loading model.</span>
<span class="sd">        max_len : int, optional</span>
<span class="sd">            Max sequence length for building tokenizer, by default None</span>
<span class="sd">        model_path : str</span>
<span class="sd">            Path to save model checkpoints</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Error raised if neither texts nor clf is provided</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_len&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_SEQUENCE_LENGTH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="k">if</span> <span class="n">vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">vec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                                                      <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                      <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
                <span class="n">filepath</span><span class="o">=</span><span class="n">model_path</span> <span class="o">+</span> <span class="s1">&#39;/epoch_</span><span class="si">{epoch}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">texts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="n">clf</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Successfully loaded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">texts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Building </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_layers</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Successfully built </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model needs either texts or &#39;</span>
                             <span class="s1">&#39;clf to be initialized&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layer_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">layers</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model layers: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_names</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;BASE_NN_MODEL&quot;</span>

<div class="viewcode-block" id="NNmodel.standardize_grams"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.standardize_grams">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">standardize_grams</span><span class="p">(</span><span class="n">grams</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Standarize vocab. Lower and remove punctuation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        grams : dict</span>
<span class="sd">            Dictionary of grams with values as gram count</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        clean_grams : dict</span>
<span class="sd">            Dictionary of standardized grams with values as gram count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clean_grams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Standardizing vocabulary with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">grams</span><span class="p">)</span><span class="si">}</span><span class="s1"> words&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gram</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">grams</span><span class="p">):</span>
            <span class="n">clean_gram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">gram</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">clean_grams</span><span class="p">[</span><span class="n">clean_gram</span><span class="p">]</span> <span class="o">=</span> <span class="n">clean_grams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">clean_gram</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">clean_grams</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">clean_grams</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;unk&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clean_grams</span></div>

<div class="viewcode-block" id="NNmodel.get_vocab_difference"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.get_vocab_difference">[docs]</a>    <span class="k">def</span> <span class="nf">get_vocab_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get difference in direct vocab and adapted vocab</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        texts : list | ndarray | pd.DataFrame</span>
<span class="sd">            Set of texts used to build vocabulary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">direct_vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_grams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vocab_direct</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">TextVectorization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;encoder&#39;</span><span class="p">)</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_vocab</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">texts</span><span class="p">)</span>
        <span class="n">adapted_vocab</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">get_vocabulary</span><span class="p">()</span>
        <span class="n">vocab_diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">direct_vocab</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">adapted_vocab</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Difference in direct vocab and adapted vocab: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vocab_diff</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">direct_vocab</span><span class="p">)</span><span class="si">}</span><span class="s1"> words in direct_vocab and &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">adapted_vocab</span><span class="p">)</span><span class="si">}</span><span class="s1"> words in adapted_vocab&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab_diff</span><span class="p">)</span><span class="si">}</span><span class="s1"> words in vocab_diff&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNmodel.construct_vocab"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.construct_vocab">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">construct_vocab</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">texts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct vocab with encoder</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        encoder : layers.TextVectorization</span>
<span class="sd">            TextVectorization layer used to build network</span>
<span class="sd">        texts : list | ndarray | pd.DataFrame</span>
<span class="sd">            Set of texts used to build vocabulary</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        encoder : layers.TextVectorization</span>
<span class="sd">            TextVectorization layer used to build network which has been</span>
<span class="sd">            adapted to get vocab</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Constructing vocabulary&#39;</span><span class="p">)</span>
        <span class="n">text_dataset</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">([</span><span class="n">texts</span><span class="p">])</span>
        <span class="n">encoder</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">text_dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoder</span></div>

<div class="viewcode-block" id="NNmodel.get_most_common_ngrams"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.get_most_common_ngrams">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_most_common_ngrams</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get most common of each ngram</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vocab : list</span>
<span class="sd">            List of ngrams which have been built previously</span>
<span class="sd">        n_min : int | None</span>
<span class="sd">            Minimum size of ngram used when building vocab</span>
<span class="sd">        m_max : int | None</span>
<span class="sd">            Maximum size of ngram used when building vocab</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_ngrams</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ngram_record</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n_min</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding the most frequent of each ngram&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ngram_record</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">max_ngrams</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
                        <span class="n">ngram_record</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The most frequent of each ngram is:</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">max_ngrams</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNmodel.get_ngrams"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.get_ngrams">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_ngrams</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create char n grams from text</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        text : str</span>
<span class="sd">            Text string for which to compute ngrams</span>
<span class="sd">        n_min : int | None</span>
<span class="sd">            Minimum size of ngram used when building vocab</span>
<span class="sd">        m_max : int | None</span>
<span class="sd">            Maximum size of ngram used when building vocab</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grams : dict</span>
<span class="sd">            Dictionary of grams with values as gram count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">gram</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>
                <span class="n">grams</span><span class="p">[</span><span class="n">gram</span><span class="p">]</span> <span class="o">=</span> <span class="n">grams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gram</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">grams</span></div>

<div class="viewcode-block" id="NNmodel.chunk_words"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.chunk_words">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">chunk_words</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create char ngrams from word</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        text : str</span>
<span class="sd">            Text string for which to compute ngrams</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grams : dict</span>
<span class="sd">            Dictionary of grams with values as gram count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">gram</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>
                    <span class="n">grams</span><span class="p">[</span><span class="n">gram</span><span class="p">]</span> <span class="o">=</span> <span class="n">grams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gram</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">grams</span></div>

<div class="viewcode-block" id="NNmodel.split_words"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.split_words">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">split_words</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split text into words</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        text : str</span>
<span class="sd">            Text string for which to compute ngrams</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grams : dict</span>
<span class="sd">            Dictionary of grams with values as gram count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">gram</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">grams</span><span class="p">[</span><span class="n">gram</span><span class="p">]</span> <span class="o">=</span> <span class="n">grams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gram</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">grams</span></div>

<div class="viewcode-block" id="NNmodel.get_vocab_direct"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.get_vocab_direct">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_vocab_direct</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">chunk_words</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get vocab direct from texts</span>

<span class="sd">        texts : list | ndarray | pd.DataFrame</span>
<span class="sd">            List of texts for which to compute vocab</span>
<span class="sd">        n_min : int | None</span>
<span class="sd">            Minimum size of ngram used when building vocab</span>
<span class="sd">        m_max : int | None</span>
<span class="sd">            Maximum size of ngram used when building vocab</span>
<span class="sd">        chunk_words : bool</span>
<span class="sd">            Whether to compute ngrams on individual words</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of words or ngrams</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting vocab direct from training texts&#39;</span><span class="p">)</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grams</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_ngrams</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">chunk_words</span><span class="p">:</span>
                <span class="n">grams</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">chunk_words</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grams</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">split_words</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gram</span> <span class="ow">in</span> <span class="n">grams</span><span class="p">:</span>
                <span class="n">vocab</span><span class="p">[</span><span class="n">gram</span><span class="p">]</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gram</span><span class="p">,</span> <span class="n">grams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gram</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">vocab</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">standardize_grams</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Vocabulary has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1"> words&#39;</span><span class="p">)</span>
        <span class="n">most_frequent</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                         <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">}</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">get_most_common_ngrams</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The most frequent 10 words are:</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">most_frequent</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="NNmodel.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.build_layers">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="NNmodel.train"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train model and evaluate</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        train_gen : WeightedGenerator</span>
<span class="sd">            WeightedGenerator instance used for training batches</span>
<span class="sd">        test_gen : WeightedGenerator</span>
<span class="sd">            WeightedGenerator instance used for evaluation batches</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary with optional keyword parameters. Can include</span>
<span class="sd">            sample_size, batch_size, epochs, n_batches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_class_info</span><span class="p">()</span>
        <span class="n">train_gen</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">test_gen</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epochs&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_history</span><span class="p">(</span><span class="n">history</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNmodel.append_history"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.append_history">[docs]</a>    <span class="k">def</span> <span class="nf">append_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append history if continuing training or define history attribute</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        history : dict</span>
<span class="sd">            Dictionary containing training history</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                                      <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNmodel.transform"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform texts</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : list | ndarray | pd.DataFrame</span>
<span class="sd">            Set of texts to transform before sending to model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        X : list | ndarray | pd.DataFrame</span>
<span class="sd">            Set of transformed texts ready to send to model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_texts</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div>

<div class="viewcode-block" id="NNmodel.fit"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        train_gen : WeightedGenerator</span>
<span class="sd">            WeightedGenerator instance used for training batches</span>
<span class="sd">        test_gen : WeightedGenerator</span>
<span class="sd">            WeightedGenerator instance used for evaluation batches</span>
<span class="sd">        epochs : int</span>
<span class="sd">            Number of epochs to train model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary of training history</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fitting model&#39;</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_gen</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                               <span class="n">validation_data</span><span class="o">=</span><span class="n">test_gen</span><span class="p">,</span>
                               <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">history</span></div>

<div class="viewcode-block" id="NNmodel.predict_proba"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict probability</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : ndarray | list | pd.DataFrame</span>
<span class="sd">            Set of texts to classify</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Whether to show progress bar for predictions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of probabilities of having label=1 for input texts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Making predictions on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_in</span><span class="p">)</span><span class="si">}</span><span class="s1"> inputs&#39;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_in</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_in</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_in</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_in</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span></div>

<div class="viewcode-block" id="NNmodel.evaluate"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_gen : WeightedGenerator</span>
<span class="sd">            WeightedGenerator instance used for model evaluation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of evaluation results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Evaluating model&#39;</span><span class="p">)</span>
        <span class="n">accr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_gen</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">accr</span></div>

<div class="viewcode-block" id="NNmodel.load"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inpath : str</span>
<span class="sd">            Path from which to load model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Initialized NNmodel model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model from </span><span class="si">{</span><span class="n">inpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;.joblib&#39;</span> <span class="ow">in</span> <span class="n">inpath</span><span class="p">:</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">inpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="n">inpath</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">inpath</span><span class="p">)</span>
        <span class="n">vec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;vectorizer.pkl&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vec_path</span><span class="p">):</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">TokVectorizer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">vec_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">clf</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span> <span class="n">model_path</span><span class="o">=</span><span class="n">inpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">history_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;history.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history_path</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">history_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="NNmodel.print_eval"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.NNmodel.html#modbot.training.models.NNmodel.print_eval">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_eval</span><span class="p">(</span><span class="n">accr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log evaluation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        accr : list</span>
<span class="sd">            List of evaluation results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Test set</span><span class="se">\n</span><span class="s1">  Loss: </span><span class="si">{:0.3f}</span><span class="se">\n</span><span class="s1">  Accuracy: </span><span class="si">{:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">accr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">accr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div></div>


<div class="viewcode-block" id="LSTM"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.LSTM.html#modbot.training.models.LSTM">[docs]</a><span class="k">class</span> <span class="nc">LSTM</span><span class="p">(</span><span class="n">NNmodel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;LSTM model for moderation&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LSTM.get_encoder"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.LSTM.html#modbot.training.models.LSTM.get_encoder">[docs]</a>    <span class="k">def</span> <span class="nf">get_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk_words</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get encoding layer for network input</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        texts : list | ndarray | pd.DataFrame</span>
<span class="sd">            Set of texts used to build vocabulary</span>
<span class="sd">        n_min : int | None</span>
<span class="sd">            Minimum size of ngram used when building vocab</span>
<span class="sd">        m_max : int | None</span>
<span class="sd">            Maximum size of ngram used when building vocab</span>
<span class="sd">        chunk_words : bool</span>
<span class="sd">            Whether to compute ngrams on individual words</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        layers.TextVectorization</span>
<span class="sd">            TextVectorization layer used to build network</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vocab_direct</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="p">,</span> <span class="n">chunk_words</span><span class="p">)</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">TextVectorization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">vocabulary</span><span class="o">=</span><span class="n">vocab</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoder</span></div>

<div class="viewcode-block" id="LSTM.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.LSTM.html#modbot.training.models.LSTM.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        texts : list | ndarray | pd.DataFrame</span>
<span class="sd">            List of texts from which to build vocab</span>
<span class="sd">        n_min : int | None</span>
<span class="sd">            Minimum size of ngram used when building vocab</span>
<span class="sd">        m_max : int | None</span>
<span class="sd">            Maximum size of ngram used when building vocab</span>
<span class="sd">        chunk_words : bool</span>
<span class="sd">            Whether to compute ngrams on each word</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        keras.Sequential</span>
<span class="sd">            Sequential model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">texts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;texts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">n_min</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_min&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">n_max</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_max&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">chunk_words</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chunk_words&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Must provide texts to build layers for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">texts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_encoder</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="n">n_max</span><span class="p">,</span>
                                   <span class="n">chunk_words</span><span class="o">=</span><span class="n">chunk_words</span><span class="p">)</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">get_vocabulary</span><span class="p">()</span>
        <span class="n">max_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
        <span class="n">embedder</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">max_words</span><span class="p">,</span>
                                    <span class="n">output_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">EMBEDDING_DIM</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">embedder</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">SpatialDropout1D</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;out_layer&#39;</span><span class="p">,</span>
                               <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(),</span>
                      <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">),</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">model</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;LSTM&#39;</span></div>


<div class="viewcode-block" id="CNN"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.CNN.html#modbot.training.models.CNN">[docs]</a><span class="k">class</span> <span class="nc">CNN</span><span class="p">(</span><span class="n">NNmodel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Moderation model using convolution layer&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CNN.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.CNN.html#modbot.training.models.CNN.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of config parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        keras.Sequential</span>
<span class="sd">            Keras model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;texts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Must provide texts to build layers for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">texts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">embedder</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_NB_WORDS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span>
                                    <span class="n">input_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;token_embedder&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Initializing CNN model with max sequence len: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TokVectorizer</span><span class="p">(</span><span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">]))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">embedder</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
                                <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling1D</span><span class="p">())</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(),</span>
                      <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">),</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="CNN.transform"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.CNN.html#modbot.training.models.CNN.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;CNN&#39;</span></div>


<div class="viewcode-block" id="BERT"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BERT.html#modbot.training.models.BERT">[docs]</a><span class="k">class</span> <span class="nc">BERT</span><span class="p">(</span><span class="n">NNmodel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bert model&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BERT.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BERT.html#modbot.training.models.BERT.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of config parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        keras.Model</span>
<span class="sd">            Keras model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bert_preprocess</span><span class="p">,</span> <span class="n">bert_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_bert</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">text_input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">bert_preprocess</span><span class="p">(</span><span class="n">text_input</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">bert_encoder</span><span class="p">(</span><span class="n">preprocessed_text</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dropout&quot;</span><span class="p">)(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;pooled_output&#39;</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">text_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">out</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="BERT.init_bert"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BERT.html#modbot.training.models.BERT.init_bert">[docs]</a>    <span class="k">def</span> <span class="nf">init_bert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize BERT</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of config parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bert_preprocess : hub.KerasLayer</span>
<span class="sd">            BERT tokenizer to be used in network</span>
<span class="sd">        bert_encoder : hub.KerasLayer</span>
<span class="sd">            BERT encoder to be used in network</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bert_preproc_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bert_preprocess&#39;</span><span class="p">,</span> <span class="n">BERT_PREPROCESS</span><span class="p">)</span>
        <span class="n">bert_encoder_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bert_encoder&#39;</span><span class="p">,</span> <span class="n">BERT_ENCODER</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting BERT preprocess layer&#39;</span><span class="p">)</span>
        <span class="n">bert_preprocess</span> <span class="o">=</span> <span class="n">tf_hub</span><span class="o">.</span><span class="n">KerasLayer</span><span class="p">(</span><span class="n">bert_preproc_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting BERT encoder layer&#39;</span><span class="p">)</span>
        <span class="n">bert_encoder</span> <span class="o">=</span> <span class="n">tf_hub</span><span class="o">.</span><span class="n">KerasLayer</span><span class="p">(</span><span class="n">bert_encoder_path</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bert_encoder&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bert_preprocess</span><span class="p">,</span> <span class="n">bert_encoder</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;BERT&#39;</span></div>


<div class="viewcode-block" id="BertCNN"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCNN.html#modbot.training.models.BertCNN">[docs]</a><span class="k">class</span> <span class="nc">BertCNN</span><span class="p">(</span><span class="n">BERT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Moderation model with BERT and CNN&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BertCNN.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCNN.html#modbot.training.models.BertCNN.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of config parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        keras.Model</span>
<span class="sd">            Keras model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">CONV</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span>
        <span class="n">POOL</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling2D</span>

        <span class="n">bert_preprocess</span><span class="p">,</span> <span class="n">bert_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_bert</span><span class="p">()</span>
        <span class="n">text_input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">bert_preprocess</span><span class="p">(</span><span class="n">text_input</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">bert_encoder</span><span class="p">(</span><span class="n">preprocessed_text</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;encoder_outputs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">conv_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span>
        <span class="n">out_1</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out_2</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out_3</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out_4</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out_5</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">out_1</span><span class="p">,</span> <span class="n">out_2</span><span class="p">,</span> <span class="n">out_3</span><span class="p">,</span> <span class="n">out_4</span><span class="p">,</span> <span class="n">out_5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">text_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">out</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">model</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;BERT_CNN&quot;</span></div>


<div class="viewcode-block" id="BertLSTM"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertLSTM.html#modbot.training.models.BertLSTM">[docs]</a><span class="k">class</span> <span class="nc">BertLSTM</span><span class="p">(</span><span class="n">BERT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bert model with LSTM&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BertLSTM.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertLSTM.html#modbot.training.models.BertLSTM.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of config parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        keras.Model</span>
<span class="sd">            Keras model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">POOL</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling1D</span>
        <span class="n">LSTM</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="n">bert_preprocess</span><span class="p">,</span> <span class="n">bert_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_bert</span><span class="p">()</span>
        <span class="n">text_input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">bert_preprocess</span><span class="p">(</span><span class="n">text_input</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">bert_encoder</span><span class="p">(</span><span class="n">preprocessed_text</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">LSTM</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;encoder_outputs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:]],</span>
                       <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out_1</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out_2</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out_3</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out_4</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out_5</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">out_1</span><span class="p">,</span> <span class="n">out_2</span><span class="p">,</span> <span class="n">out_3</span><span class="p">,</span> <span class="n">out_4</span><span class="p">,</span> <span class="n">out_5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">text_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">out</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">model</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;BERT_LSTM&#39;</span></div>


<div class="viewcode-block" id="BertLstmCnn"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertLstmCnn.html#modbot.training.models.BertLstmCnn">[docs]</a><span class="k">class</span> <span class="nc">BertLstmCnn</span><span class="p">(</span><span class="n">BERT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Model with Bert, LSTM, and CNN in that order&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BertLstmCnn.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertLstmCnn.html#modbot.training.models.BertLstmCnn.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of config parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        keras.Model</span>
<span class="sd">            Keras model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">CONV</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span>
        <span class="n">POOL</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling2D</span>
        <span class="n">LSTM</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="n">bert_preprocess</span><span class="p">,</span> <span class="n">bert_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_bert</span><span class="p">()</span>
        <span class="n">text_input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">bert_preprocess</span><span class="p">(</span><span class="n">text_input</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">bert_encoder</span><span class="p">(</span><span class="n">preprocessed_text</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">LSTM</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;encoder_outputs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:]],</span>
                       <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">conv_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span>
        <span class="n">out_1</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out_2</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out_3</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out_4</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out_5</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">out_1</span><span class="p">,</span> <span class="n">out_2</span><span class="p">,</span> <span class="n">out_3</span><span class="p">,</span> <span class="n">out_4</span><span class="p">,</span> <span class="n">out_5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">text_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">out</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">model</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;BERT_LSTM_CNN&#39;</span></div>


<div class="viewcode-block" id="BertCnnLstm"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnLstm.html#modbot.training.models.BertCnnLstm">[docs]</a><span class="k">class</span> <span class="nc">BertCnnLstm</span><span class="p">(</span><span class="n">BERT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Model with Bert, CNN, and LSTM in that order&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BertCnnLstm.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnLstm.html#modbot.training.models.BertCnnLstm.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of config parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        keras.Model</span>
<span class="sd">            Keras model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">CONV</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span>
        <span class="n">LSTM</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="n">bert_preprocess</span><span class="p">,</span> <span class="n">bert_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_bert</span><span class="p">()</span>
        <span class="n">text_input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">bert_preprocess</span><span class="p">(</span><span class="n">text_input</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">bert_encoder</span><span class="p">(</span><span class="n">preprocessed_text</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;encoder_outputs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">conv_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span>
        <span class="n">out_1</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">out_2</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">out_3</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">out_4</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">out_5</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">out_1</span><span class="p">,</span> <span class="n">out_2</span><span class="p">,</span> <span class="n">out_3</span><span class="p">,</span> <span class="n">out_4</span><span class="p">,</span> <span class="n">out_5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">text_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">out</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="BertCnnLstm.combo_layer"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnLstm.html#modbot.training.models.BertCnnLstm.combo_layer">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">combo_layer</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">k_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combination layer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outputs : list</span>
<span class="sd">            List of tensors from BERT</span>
<span class="sd">        k_size : int</span>
<span class="sd">            Size of convolution kernel</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out : tf.Tensor</span>
<span class="sd">            Output of layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CONV</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span>
        <span class="n">LSTM</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">POOL</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling1D</span>

        <span class="n">conv_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">LSTM</span><span class="p">(</span><span class="n">CONV</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">k_size</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_args</span><span class="p">)(</span><span class="n">out</span><span class="p">))</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">POOL</span><span class="p">()(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;BERT_CNN_LSTM&#39;</span></div>


<div class="viewcode-block" id="SVM"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.SVM.html#modbot.training.models.SVM">[docs]</a><span class="k">class</span> <span class="nc">SVM</span><span class="p">(</span><span class="n">ModerationModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Linear SVM model&quot;&quot;&quot;</span>

    <span class="c1">#: Default parameters for tf-idf, svm, and calibrated classifier</span>
    <span class="n">PARAMS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="s1">&#39;stop_words&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;tokenizer&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                   <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="s1">&#39;min_df&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;max_df&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                   <span class="s1">&#39;analyzer&#39;</span><span class="p">:</span> <span class="s1">&#39;char_wb&#39;</span><span class="p">,</span> <span class="s1">&#39;ngram_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="s1">&#39;smooth_idf&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sublinear_tf&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                   <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize SVM model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : sklearn.Pipeline | None</span>
<span class="sd">            Previously trained sklearn pipeline object. Need to load saved</span>
<span class="sd">            model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAMS</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;vectorizer&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;classifier&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Succesfully loaded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">ft</span><span class="o">.</span><span class="n">TfidfVectorizer</span><span class="p">)</span>
            <span class="n">vparams</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">svm</span><span class="o">.</span><span class="n">LinearSVC</span><span class="p">)</span>
            <span class="n">cparams</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">CalibratedClassifierCV</span><span class="p">)</span>
            <span class="n">cvparams</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vparams</span> <span class="o">=</span> <span class="n">vparams</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cparams</span> <span class="o">=</span> <span class="n">cparams</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">TfidfVectorizer</span><span class="p">(</span><span class="o">**</span><span class="n">vparams</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">LinearSVC</span><span class="p">(</span><span class="o">**</span><span class="n">cparams</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">base_estimator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">,</span>
                                                  <span class="o">**</span><span class="n">cvparams</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;vectorizer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">)])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Succesfully built model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y_test</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;SVM&#39;</span>

<div class="viewcode-block" id="SVM.train"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.SVM.html#modbot.training.models.SVM.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        train_gen : WeightedGenerator</span>
<span class="sd">            WeightedGenerator instance used for training batches</span>
<span class="sd">        test_gen : WeightedGenerator</span>
<span class="sd">            Has no effect. For compliance with LSTM train method</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Has no effect. For compliance with LSTM train method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_class_info</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training LinearSVM classifier&#39;</span><span class="p">)</span>
        <span class="n">train_gen</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_gen</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">correct_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_gen</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">train_gen</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVM.predict_proba"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.SVM.html#modbot.training.models.SVM.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict classification</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : ndarray | list | pd.DataFrame</span>
<span class="sd">            Set of texts to classify</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Has no effect. For compliance with LSTM method</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of predicted classifications for input texts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVM.transform"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.SVM.html#modbot.training.models.SVM.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform texts</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : list | ndarray | pd.DataFrame</span>
<span class="sd">            Set of texts to transform before sending to model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        X : list | ndarray | pd.DataFrame</span>
<span class="sd">            Set of transformed texts ready to send to model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVM.load"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.SVM.html#modbot.training.models.SVM.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load SVM model from path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inpath : str</span>
<span class="sd">            Path to load model from</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SVM</span>
<span class="sd">            Previously trained and saved model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model from </span><span class="si">{</span><span class="n">inpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="KMeansComponent"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.KMeansComponent.html#modbot.training.models.KMeansComponent">[docs]</a><span class="k">class</span> <span class="nc">KMeansComponent</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;KMeans model class. With standard model methods.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span> <span class="o">=</span> <span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="KMeansComponent.get_optimal_k"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.KMeansComponent.html#modbot.training.models.KMeansComponent.get_optimal_k">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_optimal_k</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the optimal number of clusters from distortion progress&quot;&quot;&quot;</span>
        <span class="n">distortions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_clusters</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">num_clusters</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">distortions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clusters</span><span class="o">.</span><span class="n">inertia_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_clusters</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">curvature</span><span class="p">(</span><span class="n">distortions</span><span class="p">))]</span></div>

<div class="viewcode-block" id="KMeansComponent.optimize"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.KMeansComponent.html#modbot.training.models.KMeansComponent.optimize">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">comps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get optimal number of clusters&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_optimal_k</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span></div>

<div class="viewcode-block" id="KMeansComponent.fit"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.KMeansComponent.html#modbot.training.models.KMeansComponent.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit model to data&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comps</span><span class="p">),</span>
                             <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]))</span></div>

<div class="viewcode-block" id="KMeansComponent.transform"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.KMeansComponent.html#modbot.training.models.KMeansComponent.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform data before training&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]))</span></div>

<div class="viewcode-block" id="KMeansComponent.fit_transform"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.KMeansComponent.html#modbot.training.models.KMeansComponent.fit_transform">[docs]</a>    <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform data and fit model&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comps</span><span class="p">),</span>
                             <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]))</span></div></div>


<div class="viewcode-block" id="BertCnnTorchModel"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnTorchModel.html#modbot.training.models.BertCnnTorchModel">[docs]</a><span class="k">class</span> <span class="nc">BertCnnTorchModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bert Cnn model pytorch implementation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">filter_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">num_filters</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convs1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">))</span>
                                     <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="n">filter_sizes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_model</span> <span class="o">=</span> <span class="n">BertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">,</span>
                                                    <span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BertCnnTorchModel.forward"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnTorchModel.html#modbot.training.models.BertCnnTorchModel.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">input_masks</span><span class="p">,</span> <span class="n">token_type_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forward pass for model&quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">input_masks</span><span class="p">,</span>
                            <span class="n">token_type_ids</span><span class="o">=</span><span class="n">token_type_ids</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convs1</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">F</span><span class="o">.</span><span class="n">max_pool1d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">logit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logit</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BertCnnTorchModelSmall"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnTorchModelSmall.html#modbot.training.models.BertCnnTorchModelSmall">[docs]</a><span class="k">class</span> <span class="nc">BertCnnTorchModelSmall</span><span class="p">(</span><span class="n">BertCnnTorchModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bert Cnn model pytorch implementation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="n">filter_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">num_filters</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convs1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">))</span>
                                     <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="n">filter_sizes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_model</span> <span class="o">=</span> <span class="n">BertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">,</span>
                                                    <span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BertTorchModel"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertTorchModel.html#modbot.training.models.BertTorchModel">[docs]</a><span class="k">class</span> <span class="nc">BertTorchModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bert model pytorch implementation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">768</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_model</span> <span class="o">=</span> <span class="n">BertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

<div class="viewcode-block" id="BertTorchModel.forward"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertTorchModel.html#modbot.training.models.BertTorchModel.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">input_masks</span><span class="p">,</span> <span class="n">token_type_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forward pass for model&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">input_masks</span><span class="p">,</span>
                               <span class="n">token_type_ids</span><span class="o">=</span><span class="n">token_type_ids</span><span class="p">,</span>
                               <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">logit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logit</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TorchModel"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel">[docs]</a><span class="k">class</span> <span class="nc">TorchModel</span><span class="p">(</span><span class="n">NNmodel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base torch model&quot;&quot;&quot;</span>

    <span class="n">SEED</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">MAX_SEQUENCE_LENGTH</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">DLOADER_ARGS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_workers&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pin_memory&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">2e-5</span>
    <span class="n">EMBED_SIZE</span> <span class="o">=</span> <span class="mi">768</span>
    <span class="n">LOSS_FUNCTION</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">embed_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">device</span><span class="o">=</span><span class="s1">&#39;gpu&#39;</span><span class="p">):</span>
        <span class="n">embed_size</span> <span class="o">=</span> <span class="n">embed_size</span> <span class="k">if</span> <span class="n">embed_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMBED_SIZE</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span> <span class="k">if</span> <span class="n">lr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">LEARNING_RATE</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;gpu&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;**Using GPU for training/inference**&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;**Using CPU for training/inference**&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_layers</span><span class="p">(</span><span class="n">embed_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

<div class="viewcode-block" id="TorchModel.loss_fn"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.loss_fn">[docs]</a>    <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">truth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loss function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSS_FUNCTION</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">truth</span><span class="p">)</span></div>

<div class="viewcode-block" id="TorchModel.load_checkpoint"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.load_checkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">load_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load model from checkpoint&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;best_score&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer_state&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded checkpoint with epoch (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">) &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;best_score (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;BASE_TORCH_MODEL&quot;</span>

<div class="viewcode-block" id="TorchModel.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.build_layers">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build model layers&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="TorchModel.predict_proba"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make prediction on input texts&quot;&quot;&quot;</span>
        <span class="n">test_dataloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_dataloader</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">test_dataloader</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
                <span class="n">b_input_ids</span><span class="p">,</span> <span class="n">b_input_mask</span><span class="p">,</span> <span class="n">b_token_type_ids</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">(</span><span class="n">b_input_ids</span><span class="p">,</span> <span class="n">b_input_mask</span><span class="p">,</span>
                                  <span class="n">b_token_type_ids</span><span class="p">)</span>
                <span class="n">preds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">[[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">]</span></div>

<div class="viewcode-block" id="TorchModel.eval_score"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.eval_score">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_score</span><span class="p">(</span><span class="n">df_scores</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluation score to determine whether to save model&quot;&quot;&quot;</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">df_scores</span><span class="p">[</span><span class="s1">&#39;TP&#39;</span><span class="p">])</span>
        <span class="n">tn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">df_scores</span><span class="p">[</span><span class="s1">&#39;TN&#39;</span><span class="p">])</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">df_scores</span><span class="p">[</span><span class="s1">&#39;F1&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">tn</span> <span class="o">+</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">f1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TorchModel.evaluate"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dev_dataloader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate model on test data&quot;&quot;&quot;</span>
        <span class="n">val_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">val_loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluating on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dev_dataloader</span><span class="p">)</span><span class="si">}</span><span class="s1"> batches for &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dev_dataloader</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
                <span class="n">b_input_ids</span><span class="p">,</span> <span class="n">b_input_mask</span><span class="p">,</span> <span class="n">b_token_type_ids</span><span class="p">,</span> <span class="n">b_labels</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">(</span><span class="n">b_input_ids</span><span class="p">,</span> <span class="n">b_input_mask</span><span class="p">,</span>
                                  <span class="n">b_token_type_ids</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">b_labels</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">val_preds</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">y_pred</span><span class="p">]</span>
                <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                    <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_preds</span></div>

<div class="viewcode-block" id="TorchModel.batch_update"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.batch_update">[docs]</a>    <span class="k">def</span> <span class="nf">batch_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Go through single batch pass and update loop&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
        <span class="n">b_input_ids</span><span class="p">,</span> <span class="n">b_input_mask</span> <span class="o">=</span> <span class="n">out</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">b_token_type_ids</span><span class="p">,</span> <span class="n">b_labels</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">(</span><span class="n">b_input_ids</span><span class="p">,</span> <span class="n">b_input_mask</span><span class="p">,</span>
                          <span class="n">b_token_type_ids</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">b_labels</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">train_loss</span></div>

<div class="viewcode-block" id="TorchModel.save_check"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.save_check">[docs]</a>    <span class="k">def</span> <span class="nf">save_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="n">model_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate model and check if eval merits saving&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detailed_score</span><span class="p">(</span><span class="n">test_gen</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_score</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">. New score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s1">. &#39;</span>
               <span class="sa">f</span><span class="s1">&#39;Old score: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">model_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;New best_score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s1">. Saving new best model.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_train_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Training loop for pytorch model&quot;&quot;&quot;</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epochs&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="n">eval_steps</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_steps&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">train_batches</span> <span class="o">=</span> <span class="n">train_gen</span><span class="o">.</span><span class="n">n_batches</span>
        <span class="n">total_steps</span> <span class="o">=</span> <span class="n">train_batches</span> <span class="o">*</span> <span class="n">epochs</span>
        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">get_linear_schedule_with_warmup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="o">=</span><span class="n">total_steps</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting training&#39;</span><span class="p">)</span>
        <span class="n">train_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
        <span class="n">end_epoch</span> <span class="o">=</span> <span class="n">start_epoch</span> <span class="o">+</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_steps</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_epoch</span><span class="p">,</span> <span class="n">end_epoch</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
                <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_gen</span><span class="o">.</span><span class="n">chunks</span><span class="p">):</span>
                    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">train_gen</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">chunk</span><span class="p">],</span>
                                                      <span class="n">Y</span><span class="o">=</span><span class="n">train_gen</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">chunk</span><span class="p">],</span>
                                                      <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;chunk </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">train_gen</span><span class="o">.</span><span class="n">n_chunks</span><span class="si">}</span><span class="s1">, &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;batch </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span><span class="si">}</span><span class="s1">, &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">end_epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_update</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span>
                                                       <span class="n">scheduler</span><span class="p">)</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_count</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                 <span class="ow">or</span> <span class="p">(</span><span class="n">step_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">train_batches</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">eval_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_count</span> <span class="o">%</span> <span class="n">eval_steps</span> <span class="o">==</span> <span class="mi">0</span>
                                      <span class="ow">or</span> <span class="n">step_count</span> <span class="o">%</span> <span class="n">train_batches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">eval_check</span> <span class="o">=</span> <span class="n">eval_check</span> <span class="ow">and</span> <span class="n">check</span>
                        <span class="k">if</span> <span class="n">eval_check</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">save_check</span><span class="p">(</span><span class="n">test_gen</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
                        <span class="n">train_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">step_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">train_losses</span>

<div class="viewcode-block" id="TorchModel.train"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train pytorch model&quot;&quot;&quot;</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_class_info</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_loop</span><span class="p">(</span><span class="n">train_gen</span><span class="p">,</span> <span class="n">test_gen</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer_state&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span></div>

<div class="viewcode-block" id="TorchModel.save"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model_state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                          <span class="s1">&#39;optimizer_state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                          <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">,</span>
                          <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">}</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">outpath</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model saved to </span><span class="si">{</span><span class="n">outpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Outpath is None. Not saving </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns dataloader for input to training or prediction methods&quot;&quot;&quot;</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_SEQUENCE_LENGTH</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_texts</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_encode_plus</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span>
                                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span>
                                             <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
                                             <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">,</span>
                                             <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;token_type_ids&quot;</span><span class="p">],</span>
                   <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;token_type_ids&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="TorchModel.transform"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns dataloader for input to training or prediction methods&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">SequentialSampler</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                         <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">DLOADER_ARGS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="TorchModel.load"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.TorchModel.html#modbot.training.models.TorchModel.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load pytorch model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model from </span><span class="si">{</span><span class="n">inpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">checkpoint</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inpath</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Inpath is not None. Not loading </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;model.&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BertCnnTorch"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnTorch.html#modbot.training.models.BertCnnTorch">[docs]</a><span class="k">class</span> <span class="nc">BertCnnTorch</span><span class="p">(</span><span class="n">TorchModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bert Cnn model pytorch implementation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args</span>
<span class="sd">            same args as base class</span>
<span class="sd">        kwargs</span>
<span class="sd">            same kwargs as base class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BertCnnTorch.loss_fn"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnTorch.html#modbot.training.models.BertCnnTorch.loss_fn">[docs]</a>    <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">truth</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">preds</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">truth</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">preds</span><span class="p">)</span> <span class="o">*</span> <span class="n">truth</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSS_FUNCTION</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">truth</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;BERT_CNN_TORCH&quot;</span>

<div class="viewcode-block" id="BertCnnTorch.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnTorch.html#modbot.training.models.BertCnnTorch.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BertCnnTorchModel</span><span class="p">(</span><span class="n">embed_size</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BertCnnTorchSmall"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnTorchSmall.html#modbot.training.models.BertCnnTorchSmall">[docs]</a><span class="k">class</span> <span class="nc">BertCnnTorchSmall</span><span class="p">(</span><span class="n">BertCnnTorch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bert Cnn model pytorch implementation&quot;&quot;&quot;</span>
    <span class="n">MAX_SEQUENCE_LENGTH</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;BERT_CNN_TORCH_SMALL&quot;</span>

<div class="viewcode-block" id="BertCnnTorchSmall.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertCnnTorchSmall.html#modbot.training.models.BertCnnTorchSmall.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BertCnnTorchModelSmall</span><span class="p">(</span><span class="n">embed_size</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BertTorch"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertTorch.html#modbot.training.models.BertTorch">[docs]</a><span class="k">class</span> <span class="nc">BertTorch</span><span class="p">(</span><span class="n">BertCnnTorch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bert model pytorch implementation&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;BERT_TORCH&quot;</span>

<div class="viewcode-block" id="BertTorch.build_layers"><a class="viewcode-back" href="../../../_autosummary/modbot.training.models.BertTorch.html#modbot.training.models.BertTorch.build_layers">[docs]</a>    <span class="k">def</span> <span class="nf">build_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BertTorchModel</span><span class="p">(</span><span class="n">embed_size</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Brandon Benton.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>